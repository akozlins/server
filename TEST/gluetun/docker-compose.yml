#

x-base: &base
  dns_search: .
  logging: { options: { max-size: "1m" } }
  restart: "always"
  stop_grace_period: "10s"
  security_opt: [ "no-new-privileges:true" ]

x-service: &service
  <<: *base
  cap_drop: [ "ALL" ]
  read_only: true
  user: "1000:1000"

services:

  gluetun:
    <<: *base
    image: "qmcgaw/gluetun"
    cap_add: [ "NET_ADMIN" ]
    devices: [ "/dev/net/tun:/dev/net/tun" ]
    environment:
      #VPN_SERVICE_PROVIDER: "custom"
      #OPENVPN_CUSTOM_CONFIG: "/gluetun/custom.ovpn"
      VPN_SERVICE_PROVIDER: "mullvad"
      VPN_TYPE: "openvpn"
      #VPN_TYPE: "wireguard"
      OPENVPN_USER: "${OVPN_USER:?}"
      OPENVPN_PASSWORD: "${OVPN_PASSWORD:?}"
      WIREGUARD_PRIVATE_KEY: "${WG_KEY:?}"
      WIREGUARD_ADDRESSES: "${WG_ADDR:?}"
      WIREGUARD_ENDPOINT_PORT: "443"
      SERVER_REGIONS: "Netherlands"
    networks: [ "default", "inet", "traefik" ]
    volumes:
      - ./.local/gluetun:/gluetun

  dut:
    <<: *base
    image: "archlinux"
    network_mode: "service:gluetun"
    profiles: [ "TEST" ]

networks:
  default: { internal: true }
  inet: { external: true }
  traefik: { external: true }
