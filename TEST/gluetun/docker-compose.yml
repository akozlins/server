#

x-base: &base
  dns_search: .
  logging: { options: { max-size: "1m" } }
  restart: "always"
  stop_grace_period: "10s"
  security_opt: [ "no-new-privileges:true" ]

x-service: &service
  <<: *base
  cap_drop: [ "ALL" ]
  read_only: true
  user: "1000:1000"

services:

  gluetun:
    <<: *service
    image: "qmcgaw/gluetun"
    cap_add: [ "NET_ADMIN" ]
    devices: [ "/dev/net/tun:/dev/net/tun" ]
    environment:
      VPN_SERVICE_PROVIDER: "custom"
      VPN_TYPE: "openvpn"
      OPENVPN_CUSTOM_CONFIG: "/gluetun/custom.conf"
      #DOT: "off"
      #DNS_ADDRESS: "8.8.8.8"
      #HEALTH_VPN_DURATION_INITIAL: "61s"
    volumes:
      - ./gluetun.conf:/gluetun/custom.conf
    profiles: [ "TEST" ]

  gluetun-mullvad:
    <<: *service
    image: "qmcgaw/gluetun"
    cap_add: [ "NET_ADMIN" ]
    devices: [ "/dev/net/tun:/dev/net/tun" ]
    environment:
      VPN_SERVICE_PROVIDER: "mullvad"
      VPN_TYPE: "wireguard"
      WIREGUARD_PRIVATE_KEY: "${MULLVAD_KEY:?}"
      WIREGUARD_ADDRESSES: "${MULLVAD_ADDR:?}"
      WIREGUARD_ENDPOINT_PORT: "443"
      SERVER_CITIES: "Amsterdam"
    networks: [ "default", "inet" ]
    profiles: [ "TEST" ]

  dut:
    <<: *base
    image: "archlinux"
    network_mode: "service:gluetun-mullvad"
    profiles: [ "TEST" ]

  whoami1:
    <<: *service
    image: "containous/whoami"
    depends_on: [ "gluetun-mullvad" ]
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.whoami1.middlewares=auth@file"
      - "traefik.http.routers.whoami1.rule=PathPrefix(`/whoami1/`)"
      - "traefik.http.services.whoami1.loadbalancer.server.port=80"
    network_mode: "service:gluetun-pia"

networks:
  default: { internal: true }
  inet: { external: true }
  traefik: { external: true }
