#

x-service: &service
  logging: { options: { max-size: "1m" } }
  restart: "always"
  stop_grace_period: "5s"
#  cap_drop: [ "ALL" ]
#  read_only: true
  security_opt: [ "no-new-privileges:true" ]

services:

  wallabag:
    << : *service
    image: "wallabag/wallabag"
    depends_on: [ "redis" ]
    environment:
      - "SYMFONY__ENV__DOMAIN_NAME=https://wallabag-${HOST:?}.${DOMAIN:?}"
      - "SYMFONY__ENV__SERVER_NAME=wallabag"
      - "SYMFONY__ENV__TWOFACTOR_AUTH=false"
      - "SYMFONY__ENV__FOSUSER_REGISTRATION=false"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.wallabag.middlewares=auth@file"
      - "traefik.http.routers.wallabag.rule=HostRegexp(`^wallabag(-[0-9a-z]+)?[.]`) && PathRegexp(`^/`)"
      - "traefik.http.services.wallabag.loadbalancer.server.port=80"
    networks: [ "default", "inet", "traefik" ]
    volumes:
      - ".local/wallabag/data:/var/www/wallabag/data"
      - ".local/wallabag/images:/var/www/wallabag/web/assets/images"

  redis:
    << : *service
    image: redis:alpine
    networks: [ "default" ]
    volumes:
      - ".local/redis:/data"

networks:
  default: { internal: true }
  inet: { external: true }
  traefik: { external: true }
