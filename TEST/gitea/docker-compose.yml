#

x-service: &service
  dns_search: .
  logging: { options: { max-size: "1m" } }
  restart: "always"
  stop_grace_period: "10s"
  cap_drop: [ "ALL" ]
  #read_only: true
  security_opt: [ "no-new-privileges:true" ]
  user: "1000:1000"

services:

  gitea:
    <<: *service
    image: "gitea/gitea:latest-rootless"
    environment:
      #- USER_GID=1000
      #- USER_UID=1000
      - ROOT_URL=https://${HOST:?}.${DOMAIN:?}/gitea/
      - STATIC_URL_PREFIX=/gitea
    labels:
      - "traefik.enable=true"
      - "traefik.http.middlewares.gitea.stripprefix.prefixes=/gitea"
      - "traefik.http.routers.gitea.middlewares=auth@file,gitea"
      - "traefik.http.routers.gitea.rule=PathPrefix(`/gitea/`)"
      - "traefik.http.services.gitea.loadbalancer.server.port=3000"
    networks: [ "inet", "traefik" ]
    #ports: [ "127.0.0.1:22:2222" ]
    volumes:
      - "./.local/gitea:/var/lib/gitea"
      - "./.local/gitea:/etc/gitea"

networks:
  inet: { external: true }
  traefik: { external: true }
