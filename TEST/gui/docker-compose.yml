#

x-service: &service
  logging: { options: { max-size: "1m" } }
  restart: "always"
  stop_grace_period: "5s"

services:

  test:
    <<: *service
    #build: { dockerfile: "./Dockerfile" }
    image: "archlinux"
    #cap_add: [ "SYS_ADMIN" ]
    command: zsh
    environment:
      DISPLAY: "${DISPLAY:?}"
      XAUTHORITY: "${XAUTHORITY:?}"
      HOME: "${HOME0:?}"
      HOST: "docker"
    hostname: "${HOST:?}" # match host in .Xauthority
    networks: [ "inet", "traefik" ]
    security_opt:
      - apparmor=unconfined # fix gedit
      - seccomp=unconfined # fix code
    tmpfs: [ "/tmp:mode=777", "${HOME0:?}:uid=1000", "/run/user/1000:uid=1000" ]
    user: "1000:1000"
    volumes:
      - "/opt:/opt:ro"
      - "/usr:/usr:ro"
      - "/tmp/.X11-unix:/tmp/.X11-unix"
      - "${XAUTHORITY:?}:${XAUTHORITY:?}"

networks:
  inet: { external: true }
  traefik: { external: true }
